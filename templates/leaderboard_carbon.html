{% extends "bootstrap/layout.html" %}
{% block content %}
{% include nav%}

<div id="leaderboard-container" class="container mt-3">
    <h2>
        {{ leaderboardCarbonTitle if leaderboardCarbonTitle is defined else 'Carbon leaderboard' }}
    </h2>
    
    <br>

    {% include "leaderboardNav.html"%}

    <br>

    <table id="leaderboard" class="table table-striped table-bordered display nowrap">
        <thead class="thead">
            <tr>
                <th></th>
                <th>{{ leaderboardRank }}</th>
                <th>{{ leaderboardUsername }}</th>
                <th>{{ leaderboardTotalTrips }}</th>
                <th>{{ leaderboardTotalKm }}</th>
                <th>{{ leaderboardTotalCarbon }}</th>
                <th>{{ leaderboardCarbonPerKm }}</th>
                <th>{{ leaderboardLastActive }}</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
var table = $('#leaderboard');

$.get('{{url_for("getLeaderboardUsers", type="carbon")}}', function(users, status){

    function generateLink(username, highlighted=false) {
        if (users.non_public_users.includes(username)) {
            return `${username}`;
        } else if (highlighted) {
            return `<a class="leaderboardLink link-light" href="{{url_for('public', username="")}}${username}">${username}</a>`;
        } else {
            return `<a class="leaderboardLink link-dark" href="{{url_for('public', username="")}}${username}">${username}</a>`;
        }
    }

    function formatDate(d) {
        return new Intl.DateTimeFormat('en-IE', { dateStyle: 'medium', timeStyle: 'short' }).format(new Date(d));
    }

    // No decimals in display; show exact raw value in tooltip
    function formatMass(valueKg) {
        if (valueKg >= 1000) {
            const t = valueKg / 1000; // tonnes
            return { display: Math.round(t).toLocaleString() + ' t', tooltip: `${valueKg.toLocaleString(undefined, { maximumFractionDigits: 6 })} kg` };
        } else if (valueKg >= 1) {
            return { display: Math.round(valueKg).toLocaleString() + ' kg', tooltip: `${valueKg.toLocaleString(undefined, { maximumFractionDigits: 6 })} kg` };
        } else {
            const g = valueKg * 1000;
            return { display: Math.round(g).toLocaleString() + ' g', tooltip: `${g.toLocaleString(undefined, { maximumFractionDigits: 6 })} g` };
        }
    }

    function formatPerKm(valueKgPerKm) {
        const gPerKm = valueKgPerKm * 1000;
        if (gPerKm >= 1000) {
            const kgPerKm = gPerKm / 1000;
            return { display: Math.round(kgPerKm).toLocaleString() + ' kg/km', tooltip: `${valueKgPerKm.toLocaleString(undefined, { maximumFractionDigits: 6 })} kg/km` };
        } else {
            return { display: Math.round(gPerKm).toLocaleString() + ' g/km', tooltip: `${gPerKm.toLocaleString(undefined, { maximumFractionDigits: 6 })} g/km` };
        }
    }

    function formatKm(valueMeters) {
        const km = mToKm(valueMeters);
        return { display: Math.round(km).toLocaleString() + ' km', tooltip: `${km.toLocaleString(undefined, { maximumFractionDigits: 3 })} km` };
    }

    function withTooltip(text, title) {
        return `<span data-bs-toggle="tooltip" data-bs-placement="top" title="${title}">${text}</span>`;
    }

    users.leaderboard_data.forEach(function(user){
        if (user.trips < 10) return; // Filter out users with fewer than 10 trips

        const highlighted = user.username === '{{ username }}';

        const kmFmt = formatKm(user.total_distance);
        const massFmt = formatMass(user.total_carbon);
        const perKmFmt = formatPerKm(user.carbon_per_km);

        table.append(
            $('<tr>').addClass( highlighted ? 'highlight' : '' )
                .append($('<td>'))
                .append($('<td>'))
                .append($('<td>').html(generateLink(user.username, highlighted)))
                .append($('<td>').attr('data-sort', user.trips).text((user.trips || 0).toLocaleString()))
                .append($('<td>').attr('data-sort', mToKm(user.total_distance)).html(withTooltip(kmFmt.display, kmFmt.tooltip)))
                .append($('<td>').attr('data-sort', user.total_carbon).html(withTooltip(massFmt.display, massFmt.tooltip)))
                .append($('<td>').attr('data-sort', user.carbon_per_km).html(withTooltip(perKmFmt.display, perKmFmt.tooltip)))
                .append(
                    user.last_modified ?
                        $('<td>').attr('data-sort', user.last_modified).text(formatDate(user.last_modified))
                    :   $('<td>')
                )
        );
    });

    const dTable = $('#leaderboard').DataTable({
        paging: false,
        bPaginate: false,
        columnDefs: [
            { className: 'dtr-control', orderable: false, targets: 0 },
            { orderable: false, targets: 1 },
            { orderable: false, targets: 2 }
        ],
        responsive: { details: { type: 'column', target: 0 } },
        order: [[6, 'asc']] // Default: sort by COâ‚‚/km ascending
    });

    dTable.on('order.dt search.dt', function () {
        let i = 1;
        dTable
            .cells(null, 1, { search: 'applied', order: 'applied' })
            .every(function () { this.data(i++); });
    }).draw();

    // Enable Bootstrap 5 tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl); });
});
</script>

{% endblock %}