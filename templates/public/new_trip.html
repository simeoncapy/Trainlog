{% extends "layout.html" %}
{% block content %}
<link href="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<style>
/* Additional styles for MapLibre version */
#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    background: #1a1d28;
}

#sidebar {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100%;
    background: white;
    box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
    font-size: 0.8em;
}

#sidebar.active {
    right: 0;
}

.sidebar-tab {
    position: fixed;
    top: 105px;
    right: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-right: none;
    border-radius: 8px 0 0 8px;
    z-index: 1001;
    transition: transform 0.3s ease;
    padding: 4px;
    gap: 6px;
}

.sidebar-tab i {
    font-size: 18px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.2s;
}

.sidebar-tab i:hover {
    background-color: #f0f0f0;
}


/* When sidebar is closed — pin to screen right */
#sidebar:not(.active) ~ #sidebar-tab {
    right: 0;
    left: auto;
}

/* When sidebar is open — attach to left of sidebar */
#sidebar.active ~ #sidebar-tab {
    transform: translateX(-400px); /* match sidebar width */
}

/* Mobile responsiveness */
@media (max-width: 600px) {
    /* #sidebar.active ~ #sidebar-tab {
        left: 0;
    }

    #sidebar:not(.active) ~ #sidebar-tab {
        right: 0;
    } */
}


.control-button {
    background: white;
    border: 2px solid rgba(0,0,0,0.1);
    border-radius: 4px;
    padding: 8px;
    cursor: pointer;
    font-size: 16px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    transition: background-color 0.2s;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.control-button:hover {
    background-color: #f0f0f0;
}

.control-button.buttonSmall {
    display: none;
}

@media (max-width: 600px) {
    
    .control-button.buttonSmall {
        display: flex;
    }
    
}

/* Trip popup styles */
.trip-popup {
    padding: 5px;
    font-size: 14px;
}

/* Loading spinner - move to top */
.spinner-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

/* Position the spinner at the top */
.spinner-container .lds-spinner {
    position: absolute;
    top: 20%;
}

/* Snackbar */
#snackbar {
    visibility: hidden;
    min-width: 250px;
    margin-left: -125px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 2px;
    padding: 16px;
    position: fixed;
    z-index: 1001;
    left: 50%;
    bottom: 30px;
    font-size: 17px;
}

#snackbar.show {
    visibility: visible;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

@keyframes fadein {
    from {bottom: 0; opacity: 0;}
    to {bottom: 30px; opacity: 1;}
}

@keyframes fadeout {
    from {bottom: 30px; opacity: 1;}
    to {bottom: 0; opacity: 0;}
}

.sidebar-close-button {
    position: absolute;
    top: 0;
    right: 0;
    padding: 12px 16px;
    font-size: 28px;
    font-weight: bold;
    color: #666;
    background: white;
    z-index: 10;
    cursor: pointer;
    text-align: right;
}

/* Added Carbon Styles */
.carbonContainer {
  display: none; /* Initially hidden, shown when there's carbon data */
}

.carbon {
  color: #28a745; /* Green color for sustainability */
}

.carbon-icon {
  font-size: 0.9em;
}

.carbon_popupInfo {
  display: inline-block;
}
.currency{
    padding-top: 3.5px;
}
</style>

<div class="spinner-container"><div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>

<div id="sidebar">
  <div id="sidebar-content">
    <div class="sidebar-close-button" onclick="hideSidebar()">
        &times;
    </div>
    <div class="itineraryWrapper">
      <ul class="events" id="itinerary">
        <div id="tripDetails">
       {% if tag_description != None %}
            <div class="itinerary_tag_description">
            {% if collection_voyage == 'collection' %}
                <span class="text-nowrap"><i class="fas fa-list"></i> {{tag_description}}</span>
            {% elif collection_voyage == 'voyage' %}
                <span class="text-nowrap"><i class="fas fa-route"></i> {{tag_description}}</span>
            {% endif %}
            </div>
        {% else %}
            <div class="itinerary_tag_description"><span><br></span></div>
        {% endif %}
            <div class="modeProportionContainer">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" class="modeProportionIcon km"><path d="M177.9 494.1c-18.7 18.7-49.1 18.7-67.9 0L17.9 401.9c-18.7-18.7-18.7-49.1 0-67.9l50.7-50.7 48 48c6.2 6.2 16.4 6.2 22.6 0s6.2-16.4 0-22.6l-48-48 41.4-41.4 48 48c6.2 6.2 16.4 6.2 22.6 0s6.2-16.4 0-22.6l-48-48 41.4-41.4 48 48c6.2 6.2 16.4 6.2 22.6 0s6.2-16.4 0-22.6l-48-48 41.4-41.4 48 48c6.2 6.2 16.4 6.2 22.6 0s6.2-16.4 0-22.6l-48-48 50.7-50.7c18.7-18.7 49.1-18.7 67.9 0l92.1 92.1c18.7 18.7 18.7 49.1 0 67.9L177.9 494.1z"/></svg>
              <div class="modeProportion kmModeProportion"></div>
            </div>
            <div class="modeProportionContainer">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" class="modeProportionIcon time"><path d="M256 0a256 256 0 1 1 0 512A256 256 0 1 1 256 0zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"/></svg>
              <div class="modeProportion timeModeProportion"></div>
            </div>  
            <div class="modeProportionContainer carbonContainer">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" class="modeProportionIcon carbon" ><path d="M535.3 70.7C541.7 64.6 551 62.4 559.6 65.2C569.4 68.5 576 77.7 576 88L576 274.9C576 406.1 467.9 512 337.2 512C260.2 512 193.8 462.5 169.7 393.3C134.3 424.1 112 469.4 112 520C112 533.3 101.3 544 88 544C74.7 544 64 533.3 64 520C64 445.1 102.2 379.1 160.1 340.3C195.4 316.7 237.5 304 280 304L360 304C373.3 304 384 293.3 384 280C384 266.7 373.3 256 360 256L280 256C240.3 256 202.7 264.8 169 280.5C192.3 210.5 258.2 160 336 160C402.4 160 451.8 137.9 484.7 116C503.9 103.2 520.2 87.9 535.4 70.7z"/></svg>
              <div class="modeProportion carbonProportion"></div>
            </div>
            <div class="modeProportionContainer currencyContainer">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600" class="modeProportionIcon currencyIcon"><path d="M512 80c0 18-14.3 34.6-38.4 48c-29.1 16.1-72.5 27.5-122.3 30.9c-3.7-1.8-7.4-3.5-11.3-5C300.6 137.4 248.2 128 192 128c-8.3 0-16.4 .2-24.5 .6l-1.1-.6C142.3 114.6 128 98 128 80c0-44.2 86-80 192-80S512 35.8 512 80zM160.7 161.1c10.2-.7 20.7-1.1 31.3-1.1c62.2 0 117.4 12.3 152.5 31.4C369.3 204.9 384 221.7 384 240c0 4-.7 7.9-2.1 11.7c-4.6 13.2-17 25.3-35 35.5c0 0 0 0 0 0c-.1 .1-.3 .1-.4 .2l0 0 0 0c-.3 .2-.6 .3-.9 .5c-35 19.4-90.8 32-153.6 32c-59.6 0-112.9-11.3-148.2-29.1c-1.9-.9-3.7-1.9-5.5-2.9C14.3 274.6 0 258 0 240c0-34.8 53.4-64.5 128-75.4c10.5-1.5 21.4-2.7 32.7-3.5zM416 240c0-21.9-10.6-39.9-24.1-53.4c28.3-4.4 54.2-11.4 76.2-20.5c16.3-6.8 31.5-15.2 43.9-25.5V176c0 19.3-16.5 37.1-43.8 50.9c-14.6 7.4-32.4 13.7-52.4 18.5c.1-1.8 .2-3.5 .2-5.3zm-32 96c0 18-14.3 34.6-38.4 48c-1.8 1-3.6 1.9-5.5 2.9C304.9 404.7 251.6 416 192 416c-62.8 0-118.6-12.6-153.6-32C14.3 370.6 0 354 0 336V300.6c12.5 10.3 27.6 18.7 43.9 25.5C83.4 342.6 135.8 352 192 352s108.6-9.4 148.1-25.9c7.8-3.2 15.3-6.9 22.4-10.9c6.1-3.4 11.8-7.2 17.2-11.2c1.5-1.1 2.9-2.3 4.3-3.4V304v5.7V336zm32 0V304 278.1c19-4.2 36.5-9.5 52.1-16c16.3-6.8 31.5-15.2 43.9-25.5V272c0 10.5-5 21-14.9 30.9c-16.3 16.3-45 29.7-81.3 38.4c.1-1.7 .2-3.5 .2-5.3zM192 448c56.2 0 108.6-9.4 148.1-25.9c16.3-6.8 31.5-15.2 43.9-25.5V432c0 44.2-86 80-192 80S0 476.2 0 432V396.6c12.5 10.3 27.6 18.7 43.9 25.5C83.4 438.6 135.8 448 192 448z"/></svg>
              <div class="currency"></div>
            </div>
          {% if num_hidden_trips > 0 %}
            <div id="hiddenTripsInfo">(+{{ num_hidden_trips }} {% if num_hidden_trips == 1 %}{{ trip_view_hidden_trips_singular }}{% else %}{{ trip_view_hidden_trips_plural }}{% endif %})</div>
          {% endif %}
          <br>
          <div id="tripDate"></div>              
        </div>
      </ul>
    </div>
  </div>
</div>
<div id="sidebar-tab" class="sidebar-tab">
  <i id="sidebar-tab-icon" class="fas fa-bars" title="{{toggle}}"></i>
  <i class="fas fa-arrow-left sidebar-icon" onclick="leave()" title="{{back}}"></i>
  <i class="fas fa-clipboard sidebar-icon" onclick="copyURL()" title="{{copy}}"></i>
</div>

<div id="map" class="mapIndiv">
</div>
<div id="snackbar">{{copyLink}}</div>

<script src="https://unpkg.com/maplibre-gl@5.6.0/dist/maplibre-gl.js"></script>
<script src="{{ url_for('static', filename='js/maplibre-utils.js') }}"></script>
<script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.20/leaflet-maplibre-gl.js"></script>

<script>
// Global variables
let map;
let sidebar;
let sidebarOpen = false;

// Date formatting options
const dateOptions = { timeZone: 'UTC', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
const dateOptionsShort = { month: 'short', day: 'numeric' };

function createCarbonInfo(carbonFootprint, tripLength, langId) {
  if (!carbonFootprint || carbonFootprint <= 0) {
    return null;
  }
  
  const co2PerKm = calculateCO2PerKm(carbonFootprint, tripLength);
  const color = getCarbonColor(co2PerKm);
  const totalCarbonText = formatCarbonFootprint(carbonFootprint, langId);
  const co2PerKmText = formatCO2PerKm(co2PerKm, langId);
  const tooltipText = `${totalCarbonText} (${co2PerKmText})`;
  
  return `<div class="popupInfo carbon_popupInfo" popupinfo_content="${tooltipText}">
            <i class="fas fa-leaf carbon-icon" style="color: ${color};"></i>
          </div>`;
}

function processTrips() {
    buildItinerary(trips, prices);
    placePolylines(trips);
}

// Transport type translations
const transportTypeText = {
    "air": "{{air}}",
    "train": "{{train}}",
    "tram": "{{tram}}",
    "metro": "{{metro}}",
    "bus": "{{bus}}",
    "ferry": "{{ferry}}",
    "car": "{{car}}",
    "cycle": "{{cycle}}",
    "walk": "{{walk}}",
    "aerialway": '{{aerialway}}',
};

// Initialize map
async function initializeMapAndTrips() {
    const params = new URLSearchParams(window.location.search);
    const serverType = params.get('tileserver') || "{{ tileserver|default('osm') }}";
    const useGlobe = params.has('globe') ? params.get('globe') === 'true' : {{ 'true' if globe else 'false' }};
    
    // Load trips data first
    var tripIds = {{tripIds|tojson}};
    const response = await $.post({
        url: '{{url_for("getPublicTrips")}}',
        contentType: 'application/json',
        data: JSON.stringify({ tripIds: tripIds })
    });
    
    var trips = response[0];
    var prices = response[1];
    trips.reverse();
    
    // Get center from first trip's first coordinate
    const firstCoord = [trips[0].path[0][1], trips[0].path[0][0]];
    
    // Initialize map
    map = await MapLibreUtils.initializeMapLibre({
        container: 'map',
        tileserver: serverType,
        useGlobe: useGlobe,
        userLanguage: "{{langId}}",
        center: firstCoord,
        zoom: 5
    });
    
    // Display trips once loaded
    if (map.isStyleLoaded()) {
        buildItinerary(trips, prices);
        placePolylines(trips);
    } else {
        map.once('load', () => {
            buildItinerary(trips, prices);
            placePolylines(trips);
        });
    }
}
// Build itinerary function (same as original)
function buildItinerary(trips, prices) {
    var total_length_per_type = {};
    var total_duration_per_type = {};
    var total_carbon_per_type = {}; // Added
    var total_length = 0;
    var total_duration = 0;
    var total_carbon = 0; // Added

{% if 'price' in request.args %}              
    if (prices.total_price != 0) {
        $(".currencyContainer").show();
        $(".currency").text(formatCurrency("{{langId}}", prices.total_price, prices.user_currency));
    }
{% endif %}

{% if 'carbon' in request.args %} // Added
    if (prices.total_carbon != 0) {
        $(".carbonContainer").show();
    }
{% endif %}

    if (trips.length > 1) {
        trips.forEach(function(trip, index) {
            if (!["accommodation", "restaurant", "poi"].includes(trip.trip.type)) {
                var tripType = trip.trip.type;

                if (tripType === "helicopter") {
                    tripType = "air";
                }
                total_length += trip.trip.trip_length;
                total_duration += trip.trip.trip_duration[1];
                total_carbon += trip.trip.carbon_footprint || 0; // Added

                if (tripType in total_length_per_type) {
                    total_length_per_type[tripType] = total_length_per_type[tripType] + trip.trip.trip_length;
                    total_duration_per_type[tripType] = total_duration_per_type[tripType] + trip.trip.trip_duration[1];
                    total_carbon_per_type[tripType] = (total_carbon_per_type[tripType] || 0) + (trip.trip.carbon_footprint || 0); // Added
                } else {
                    total_length_per_type[tripType] = trip.trip.trip_length;
                    total_duration_per_type[tripType] = trip.trip.trip_duration[1];
                    total_carbon_per_type[tripType] = trip.trip.carbon_footprint || 0; // Added
                }
            }
        });

        let sortArray = [];
        for (let i in total_duration_per_type) {
            sortArray.push({key: i, value: total_duration_per_type[i]});
        }
        sortArray.sort(function(a, b) { return a.value - b.value; }).reverse();

        var kmLeft = 0, timeLeft = 0, carbonLeft = 0; // Added carbonLeft
        for (let i in sortArray) {
            var km = mToKm(total_length_per_type[sortArray[i].key]);
            var time = secondsToDhm(sortArray[i].value, "{{langId}}");
            var carbon = formatCarbonFootprint(total_carbon_per_type[sortArray[i].key] || 0, "{{langId}}"); // Added carbon calculation
            var type = transportTypeText[sortArray[i].key];

            var km_percent = (total_length_per_type[sortArray[i].key] / total_length) * 100;
            var time_percent = (total_duration_per_type[sortArray[i].key] / total_duration) * 100;
            var carbon_percent = total_carbon > 0 ? ((total_carbon_per_type[sortArray[i].key] || 0) / total_carbon) * 100 : 0; // Added carbon percent
            
            $('.kmModeProportion').append(
                $("<div>").attr("title", `${type}: ${km} km`).addClass("percent_bar").addClass(sortArray[i].key).css("width", km_percent + "%").css("left", kmLeft + "%")
            );
            kmLeft += km_percent;

            $('.timeModeProportion').append(
                $("<div>").attr("title", `${type}: ${time}`).addClass("percent_bar").addClass(sortArray[i].key).css("width", time_percent + "%").css("left", timeLeft + "%")
            );
            timeLeft += time_percent;

            // Added carbon proportion bar
            $('.carbonProportion').append(
                $("<div>").attr("title", `${type}: ${carbon}`).addClass("percent_bar").addClass(sortArray[i].key).css("width", carbon_percent + "%").css("left", carbonLeft + "%")
            );
            carbonLeft += carbon_percent;
        }
        $(".percent_bar").tooltip();

        $(".modeProportionIcon.km").attr("title", `{{totalLength}} : ${mToKm(total_length)} km`);
        $(".modeProportionIcon.time").attr("title", `{{totalDuration}} : ${secondsToDhm(total_duration, "{{langId}}")}`);
        
        // Added title for carbon icon
        if (total_carbon > 0) {
            $(".modeProportionIcon.carbon").attr("title", formatCarbonFootprint(total_carbon, "{{langId}}"));
        } else {
            $(".modeProportionIcon.carbon").attr("title", "");
        }
        $(".modeProportionIcon").tooltip();
    } else {
        $('.modeProportionContainer').hide();
    }

    // Build itinerary items (same as original)
    trips.forEach(function(trip, index) {
        var dayChangeTrip = false;
        var dayChangeIntertrip = false;
        let changeTime = 0;
        
        if (trip != trips[trips.length - 1]) {
            changeTime = timeDifference(
                trip.trip.utc_filtered_end_datetime,
                trips[index + 1].trip.utc_filtered_start_datetime
            );
            var previousDay = new Date(trip.trip.end_datetime).toISOString().slice(0, 10);
            var currentDay = new Date(trip.trip.start_datetime).toISOString().slice(0, 10);
            if (currentDay != previousDay) {
                dayChangeTrip = true;
            }
        }
        
        if (index > 0) {
            let precedingChangeTime = timeDifference(
                trips[index - 1].trip.utc_filtered_end_datetime,
                trip.trip.utc_filtered_start_datetime
            );

            var previousDay = new Date(trips[index - 1].trip.end_datetime).toISOString().slice(0, 10);
            var currentDay = new Date(trip.trip.start_datetime).toISOString().slice(0, 10);
            if (currentDay != previousDay && precedingChangeTime <= 43200) {
                dayChangeIntertrip = true;
            }
        }

        if (index == 0) {
            if (trip.trip.start_date.length > 2) {
                $('#tripDate').text(capitalizeFirstLetter(new Date(trip.trip.start_date + "T12:00:00Z").toLocaleDateString('{{langId}}', dateOptions)));
            } else {
                if (trip.trip.start_datetime == -1) {
                    $('#tripDate').text("{{past}}");
                } else {
                    $('#tripDate').text("{{project}}");
                }
            }
        }

        // Handle operator display (same as original)
        let operatorContents = [];
        if (trip.trip.multi_operators) {
            trip.trip.multi_operators.forEach(multiOperator => {
                let imgElement = $("<img>")
                    .attr("src", "/static/" + multiOperator.logo_url)
                    .attr("class", "itineraryOperatorLogo");

                let divElement = $('<div>')
                    .attr("class", "popupInfo operator_popupInfo")
                    .attr("popupInfo_content", multiOperator.operator_name)
                    .append(imgElement);
                    
                operatorContents.push(divElement);
            });
        } else if (trip.trip.logo_url) {
            let imgElement = $("<img>")
                .attr("src", "/static/" + trip.trip.logo_url)
                .attr("class", "itineraryOperatorLogo");

            let divElement = $('<div>')
                .attr("class", "popupInfo operator_popupInfo")
                .attr("popupInfo_content", trip.trip.operator)
                .append(imgElement);
                
            operatorContents.push(divElement);
        } else {
            operatorContents.push(trip.trip.operator);
        }

        let operatorLogoOrText;
        if (operatorContents.length) {
            if (typeof operatorContents[0] === 'string') {
                operatorLogoOrText = operatorContents.join(', ');
            } else {
                operatorLogoOrText = $('<div>').append(operatorContents);
            }
        }

        let lineOrNot = trip.trip.line_name != "" ? 
            (typeof operatorLogoOrText === 'object' ? 
                operatorLogoOrText.append(" - " + trip.trip.line_name) : 
                operatorLogoOrText + " - " + trip.trip.line_name) : 
            operatorLogoOrText;
        
        let operatorDisplay = $("<div>").append(trip.trip.operator != "" ? lineOrNot : null);

        let endTimeDisplay, startTimeDisplay;
        if (dayChangeTrip) {
            endTimeDisplay = $("<div>").append($('<div>').addClass('arrow_box').append($('<div>').addClass("dayChange").append((capitalizeFirstLetter(new Date(trip.trip.end_datetime).toLocaleDateString('{{langId}}', dateOptionsShort)))))).append(trip.trip.end_time.replace("(+1)", "").padStart(10, '\xa0'));
        } else {
            endTimeDisplay = trip.trip.end_time.padStart(10, '\xa0');
        }

        if (dayChangeIntertrip) {
            startTimeDisplay = capitalizeFirstLetter(new Date(trip.trip.start_datetime).toLocaleDateString('{{langId}}', dateOptionsShort)).padStart(10, '\xa0') + "<br>" + trip.trip.start_time.padStart(10, '\xa0');
        } else {
            startTimeDisplay = trip.trip.start_time.padStart(10, '\xa0');
        }

{% if 'price' in request.args %}              
        var formattedTripPrice = null;
        var formattedTicketPrice = null;
        var formattedTicketInfo = null;
        var formattedTripInfo = null;
        var formattedPrice = null;
        
        if (trip.trip.ticket_price_in_user_currency) {
            formattedTicketPrice = trip.trip.ticket + " - " + formatCurrency("{{langId}}", trip.trip.ticket_price_in_user_currency, trip.trip.user_currency);
            if (trip.trip.user_currency != trip.trip.ticket_currency) {
                let originalCurrency = formatCurrency("{{langId}}", trip.trip.ticket_price, trip.trip.ticket_currency);
                formattedTicketPrice += ` (${originalCurrency})`;
            }
            formattedTicketInfo = `<div class="popupInfo ticket_popupInfo" popupinfo_content="${formattedTicketPrice}"><i style="color:#228B22;" class="bi bi-ticket-perforated-fill"></i></div>`;
        }
        
        if (trip.trip.price_in_user_currency) {
            formattedTripPrice = formatCurrency("{{langId}}", trip.trip.price_in_user_currency, trip.trip.user_currency);
            if (trip.trip.user_currency != trip.trip.currency) {
                let originalCurrency = formatCurrency("{{langId}}", trip.trip.price, trip.trip.currency);
                formattedTripPrice += ` (${originalCurrency})`;
            }
            formattedTripInfo = `<div class="popupInfo trip_popupInfo" popupinfo_content="${formattedTripPrice}"><i style="color:#D4AF37;" class="fa-solid fa-coins"></i></div>`;
        }
        
        if (formattedTicketInfo || formattedTripInfo) {
            formattedPrice = (formattedTicketInfo || '') + (formattedTicketInfo && formattedTripInfo ? '  ' : '') + (formattedTripInfo || '');
        }
{% endif %}

{% if 'carbon' in request.args %} // Added
        var formattedCarbon = createCarbonInfo(trip.trip.carbon_footprint, trip.trip.trip_length, "{{langId}}");
{% endif %}

        // Append to itinerary
        $('#itinerary').append(
            $('<li>').append(
                $('<time>').addClass(trip.trip.type).attr("datetime", trip.trip.start_time).html(startTimeDisplay)
            ).append(
                $('<span>').attr("class", trip.trip.type).append(
                    $('<strong>').text(trip.trip.origin_station)
                ).append('<br>').append(operatorDisplay).append(
                    $("<div>").attr("class", "duration " + trip.trip.trip_duration[0]).append($('<div>').text(secondsToDhm(trip.trip.trip_duration[1], "{{langId}}") + (trip.trip.trip_length > 0 ? " - " + mToKm(trip.trip.trip_length) + "km" : "")))
                ).append('<br>').append(
                    {% if 'price' in request.args and 'carbon' in request.args %} // Modified conditional
                        $("<div>").append($('<div>').html((formattedPrice || '') + (formattedPrice && formattedCarbon ? ' ' : '') + (formattedCarbon || '')))
                    {% elif 'price' in request.args %} // Modified conditional
                        $("<div>").append($('<div>').html(formattedPrice || ''))
                    {% elif 'carbon' in request.args %} // Added conditional
                        $("<div>").append($('<div>').html(formattedCarbon || ''))
                    {% else %}
                        $("<div>").append($('<div>').html(''))
                    {% endif %}
                )
            )
        ).append(
            $('<li>').append(
                $('<time>').addClass(trip.trip.type).addClass("arrival").attr("datetime", trip.trip.end_time).html(endTimeDisplay)
            ).append(
                $('<span>').attr("class", function() {
                    if (trips.length > 1 && changeTime <= 43200) {
                        return "trainChange";
                    } else {
                        return "tripChange";
                    }
                }).append(
                    $('<strong>').text(trip.trip.destination_station)
                ).append('<br>').append(function() {
                    if (trip != trips[trips.length - 1]) {
                        if (changeTime <= 43200) {
                            let changeTimeText = changeTime != 0 ? '<br>' + secondsToDhm(changeTime, "{{langId}}") : "";
                            if (trip.trip.destination_station == trips[index + 1].trip.origin_station) {
                                return "{{trainChange}}" + changeTimeText;
                            } else {
                                return "{{stationChange}}" + changeTimeText;
                            }
                        }
                    }
                })
            )
        );
        
        if (trips.length > 1 && changeTime > 43200 && trip != trips[trips.length - 1]) {
            $('#itinerary').append('<div id="tripDetails">' + capitalizeFirstLetter(new Date(trips[index + 1].trip.start_date + "T12:00:00Z").toLocaleDateString('{{langId}}', dateOptions)) + '</div><br>');
        }
    });
}

// Calculate position for current trips
function calculatePosition(trip) {
    const currentTime = new Date().getTime();
    const tripStartTime = new Date(trip.trip.utc_filtered_start_datetime + 'Z').getTime();
    const tripEndTime = new Date(trip.trip.utc_filtered_end_datetime+ 'Z').getTime();
    const totalTripDuration = tripEndTime - tripStartTime;
    const elapsedTime = currentTime - tripStartTime;
    const progress = elapsedTime / totalTripDuration;
    return Math.min(Math.max(progress, 0), 1);
}

// Split polyline for current trips
function splitPolyline(path, progress) {
    if (path.length === 2) {
        // Use geodesic line for two-point paths
        path = MapLibreUtils.createGeodesicLine(path[0], path[1]);
    }
    const totalPoints = path.length;
    const splitIndex = Math.floor(progress * totalPoints);
    
    const pastPath = path.slice(0, splitIndex + 1);
    const futurePath = path.slice(splitIndex);
    
    return { pastPath, futurePath };
}

// Place polylines using MapLibre
function placePolylines(trips) {
    if (trips.length === 0) {
        $('.spinner-container').hide();
        return;
    }

    // Process trips with time status
    trips.forEach(trip => {
        trip = MapLibreUtils.computeTimeStatus(trip);
    });

    // Build trip layers
    const features = MapLibreUtils.buildTripLayers(map, trips, MapLibreUtils.MapConfig.transportTypes, {
        onLayerClick: (e) => {
            e.originalEvent.stopPropagation();
            showTripPopup(e);
        },
        showShadows: true
    });

// Function to create numbered circle icon on canvas
function createNumberedIcon(number) {
    const size = 100; // Double size for retina displays
    const canvas = document.createElement('canvas');
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');
    
    // Draw outer white circle (border)
    ctx.fillStyle = '#ffffff';
    ctx.beginPath();
    ctx.arc(size / 2, size / 2, size / 2 - 2, 0, Math.PI * 2);
    ctx.fill();
    
    // Draw inner blue circle
    ctx.fillStyle = '#3887be';
    ctx.beginPath();
    ctx.arc(size / 2, size / 2, size / 2 - 6, 0, Math.PI * 2);
    ctx.fill();
    
    // Draw number
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 50px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(number.toString(), size / 2, size / 2);
    
    return canvas;
}

// Update the placePolylines function numbered marker section:

{% if collection_voyage != 'collection' %}
// Collect all numbered markers data
const numberedMarkers = [];
let markerIndex = 1;

trips.forEach((trip, index) => {
    if (index !== 0) {
        numberedMarkers.push({
            coordinates: [trip.path[0][1], trip.path[0][0]],
            number: markerIndex,
            popupText: trip.trip.origin_station
        });
        markerIndex++;
    }
    
    if (index !== 0 && index < trips.length - 1) {
        if (trips[index + 1].trip.origin_station !== trips[index].trip.destination_station) {
            numberedMarkers.push({
                coordinates: [trip.path[trip.path.length - 1][1], trip.path[trip.path.length - 1][0]],
                number: markerIndex,
                popupText: trip.trip.destination_station
            });
            markerIndex++;
        }
    }
});

// Create unique icons for each number and add them to the map
if (numberedMarkers.length > 0) {
    // First, create and add all unique numbered icons
    const uniqueNumbers = [...new Set(numberedMarkers.map(m => m.number))];
    
    uniqueNumbers.forEach(num => {
        const iconCanvas = createNumberedIcon(num);
        const ctx = iconCanvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, iconCanvas.width, iconCanvas.height);
        
        map.addImage(`numbered-marker-${num}`, {
            width: iconCanvas.width,
            height: iconCanvas.height,
            data: imageData.data
        }, { pixelRatio: 2 });
    });
    
    // Create features with icon references
    const features = numberedMarkers.map(marker => ({
        type: 'Feature',
        geometry: {
            type: 'Point',
            coordinates: marker.coordinates
        },
        properties: {
            number: marker.number,
            popupText: marker.popupText,
            icon: `numbered-marker-${marker.number}`
        }
    }));
    
    // Add source
    map.addSource('numbered-markers', {
        type: 'geojson',
        data: {
            type: 'FeatureCollection',
            features: features
        }
    });
    
    // Add symbol layer with the custom icons
    map.addLayer({
        id: 'numbered-markers',
        type: 'symbol',
        source: 'numbered-markers',
        layout: {
            'icon-image': ['get', 'icon'],
            'icon-size': 0.5, // Scale down since we created at 2x
            'icon-allow-overlap': true,
            'icon-ignore-placement': true
        }
    });
    
    // Add click handler for popups
    map.on('click', 'numbered-markers', (e) => {
        e.originalEvent.stopPropagation();
        const properties = e.features[0].properties;
        if (properties.popupText) {
            new maplibregl.Popup({ offset: 25 })
                .setLngLat(e.lngLat)
                .setText(properties.popupText)
                .addTo(map);
        }
    });
    
    // Change cursor on hover
    map.on('mouseenter', 'numbered-markers', () => {
        map.getCanvas().style.cursor = 'pointer';
    });
    map.on('mouseleave', 'numbered-markers', () => {
        map.getCanvas().style.cursor = '';
    });
}
    // Add start marker (green) - first trip's origin
    if (trips.length > 0) {
        const firstTrip = trips[0];
        const lastTrip = trips[trips.length - 1];
        
        if (firstTrip.trip.origin_station === lastTrip.trip.destination_station) {
            // Round trip - same start and end station
            const startCoords = [firstTrip.path[0][1], firstTrip.path[0][0]];
            createCustomMarker(startCoords, 'red-green', `${firstTrip.trip.origin_station} - ${lastTrip.trip.destination_station}`);
        } else {
            // Different start and end stations - use separate markers
            const startCoords = [firstTrip.path[0][1], firstTrip.path[0][0]];
            const endCoords = [lastTrip.path[lastTrip.path.length - 1][1], lastTrip.path[lastTrip.path.length - 1][0]];
            
            createCustomMarker(startCoords, 'green', firstTrip.trip.origin_station);
            createCustomMarker(endCoords, 'red', lastTrip.trip.destination_station);
        }
    }
{% endif %}
    // Handle current trips with position markers
    const currentTripFeatures = [];
        trips.forEach(trip => {
            if (trip.time === 'current') {
                const progress = calculatePosition(trip);
                const { pastPath, futurePath } = splitPolyline(trip.path, progress);
                
                // Ensure coordinates are in the right format [lng, lat]
                let fullCoords = trip.path.map(c => [c[1], c[0]]);
                let futureCoords = futurePath.map(c => [c[1], c[0]]);
                
                // Handle air routes (geodesic lines)
                if (trip.trip.type === 'air' && fullCoords.length === 2) {
                    fullCoords = MapLibreUtils.createGeodesicLine(fullCoords[0], fullCoords[1]);
                }
                if (trip.trip.type === 'air' && futureCoords.length === 2) {
                    futureCoords = MapLibreUtils.createGeodesicLine(futureCoords[0], futureCoords[1]);
                }
                
                // Create full trip feature (will be styled as past)
                const fullTripFeature = {
                    type: 'Feature',
                    geometry: {
                        type: 'LineString',
                        coordinates: fullCoords
                    },
                    properties: {
                        id: trip.trip.uid + '_full',
                        type: trip.trip.type,
                        time: 'past',
                        year: trip.trip.start_datetime !== 1 && trip.trip.start_datetime !== -1
                            ? trip.trip.start_datetime.substring(0, 4)
                            : null,
                        origin: trip.trip.origin_station,
                        destination: trip.trip.destination_station
                    }
                };
                
                // Create future path feature (will be styled as plannedFuture)
                if (futureCoords.length > 1) {
                    const futureFeature = {
                        type: 'Feature',
                        geometry: {
                            type: 'LineString',
                            coordinates: futureCoords
                        },
                        properties: {
                            id: trip.trip.uid + '_future',
                            type: trip.trip.type,
                            time: 'plannedFuture',
                            year: trip.trip.start_datetime !== 1 && trip.trip.start_datetime !== -1
                                ? trip.trip.start_datetime.substring(0, 4)
                                : null,
                            origin: trip.trip.origin_station,
                            destination: trip.trip.destination_station
                        }
                    };
                    currentTripFeatures.push(futureFeature);
                }
                
                currentTripFeatures.push(fullTripFeature);
                
                // Place marker at current position
                const pegPosition = pastPath[pastPath.length - 1];
                createCustomMarker([pegPosition[1], pegPosition[0]], 'calc', 'Current Position');
            }
        });

        // Add current trip features to the map
        if (currentTripFeatures.length > 0) {
            // Add source for current trips
            map.addSource('current-trips', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: currentTripFeatures
                }
            });
            
            // Add layers for current trips
            MapLibreUtils.MapConfig.transportTypes.forEach(type => {
                const basePaint = {
                    'line-color': type.color,
                    'line-width': (type.id === 'air') ? 1 : 3,
                    'line-opacity': 0.8
                };
                
                // Current trip past layer (full trip in normal color)
                const currentPastId = `current-${type.id}-past`;
                if (!map.getLayer(currentPastId)) {
                    map.addLayer({
                        id: currentPastId,
                        type: 'line',
                        source: 'current-trips',
                        filter: ['all',
                            ['==', ['get', 'type'], type.id],
                            ['==', ['get', 'time'], 'past']
                        ],
                        layout: { 
                            'line-join': 'round', 
                            'line-cap': 'round',
                            'visibility': 'visible'
                        },
                        paint: basePaint
                    });
                    
                    // Add interactions
                    map.on('click', currentPastId, (e) => {
                        e.originalEvent.stopPropagation();
                        showTripPopup(e);
                    });
                    map.on('mouseenter', currentPastId, () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', currentPastId, () => {
                        map.getCanvas().style.cursor = '';
                    });
                }
                
                // Current trip future base layer
                const currentFutureBaseId = `current-${type.id}-future-base`;
                if (!map.getLayer(currentFutureBaseId)) {
                    map.addLayer({
                        id: currentFutureBaseId,
                        type: 'line',
                        source: 'current-trips',
                        filter: ['all',
                            ['==', ['get', 'type'], type.id],
                            ['==', ['get', 'time'], 'plannedFuture']
                        ],
                        layout: { 
                            'line-join': 'round', 
                            'line-cap': 'round',
                            'visibility': 'visible'
                        },
                        paint: basePaint
                    });
                    
                    // Add interactions
                    map.on('click', currentFutureBaseId, (e) => {
                        e.originalEvent.stopPropagation();
                        showTripPopup(e);
                    });
                    map.on('mouseenter', currentFutureBaseId, () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', currentFutureBaseId, () => {
                        map.getCanvas().style.cursor = '';
                    });
                }
                
                // Current trip future overlay (white dotted)
                const currentFutureOverlayId = `current-${type.id}-future-overlay`;
                if (!map.getLayer(currentFutureOverlayId)) {
                    map.addLayer({
                        id: currentFutureOverlayId,
                        type: 'line',
                        source: 'current-trips',
                        filter: ['all',
                            ['==', ['get', 'type'], type.id],
                            ['==', ['get', 'time'], 'plannedFuture']
                        ],
                        layout: { 
                            'line-join': 'round', 
                            'line-cap': 'round',
                            'visibility': 'visible'
                        },
                        paint: {
                            ...basePaint,
                            'line-color': '#ffffff',
                            'line-dasharray': [3, 3]
                        }
                    });
                    
                    // Add interactions
                    map.on('click', currentFutureOverlayId, (e) => {
                        e.originalEvent.stopPropagation();
                        showTripPopup(e);
                    });
                    map.on('mouseenter', currentFutureOverlayId, () => {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', currentFutureOverlayId, () => {
                        map.getCanvas().style.cursor = '';
                    });
                }
            });
        }

    // Set view to show all trips
    const simpleFilters = {
        viewMode: 'all',
        years: [],
        transportTypes: new Set(MapLibreUtils.MapConfig.transportTypes.map(t => t.id))
    };
    
    // Update visibility to show all layers
    MapLibreUtils.updateLayerVisibility(map, MapLibreUtils.MapConfig.transportTypes, simpleFilters);
    
    // Show sidebar after map is loaded
    setTimeout(() => {
    showSidebar();
    
    // Simple bounds calculation from trip data
    if (trips.length > 0) {
        const bounds = new maplibregl.LngLatBounds();
        
        trips.forEach(trip => {
            trip.path.forEach(coord => {
                bounds.extend([coord[1], coord[0]]); // [lng, lat]
            });
        });
        
        const padding = window.innerWidth > 600 ? 
            { top: 50, bottom: 50, left: 50, right: 450 } : 50;
            
        map.fitBounds(bounds, { padding });
    }
}, window.innerWidth > 600 ? 500 : 800);
    
    
    $('.spinner-container').hide();
}

// Show trip popup
function showTripPopup(e) {
    const properties = e.features[0].properties;
    
    const popupContent = `
        <div class="trip-popup">
            <p>${properties.origin} - ${properties.destination}<br>
            </p>
        </div>
    `;
    
    new maplibregl.Popup({ offset: [0, -10] })
        .setLngLat(e.lngLat)
        .setHTML(popupContent)
        .addTo(map);
}

// Create custom markers
function createCustomMarker(coordinates, type, popupText) {
    const el = document.createElement('div');
    el.className = `marker-icon marker-${type}`;
    
    // Set marker styles based on type
    let anchorY = 41; // Default anchor for bottom-pointed markers
    switch(type) {
        case 'green':
            el.style.backgroundImage = "url('{{ url_for('static',filename='images/icons/marker-icon-2x-green.png') }}')";
            el.style.width = '25px';
            el.style.height = '41px';
            break;
        case 'red':
            el.style.backgroundImage = "url('{{ url_for('static',filename='images/icons/marker-icon-2x-red.png') }}')";
            el.style.width = '25px';
            el.style.height = '41px';
            break;
        case 'red-green':
            el.style.backgroundImage = "url('{{ url_for('static',filename='images/icons/marker-icon-2x-redGreen.png') }}')";
            el.style.width = '46px';
            el.style.height = '41px';
            break;
        case 'calc':
            el.style.backgroundImage = "url('{{ url_for('static',filename='images/icons/calc.png') }}')";
            el.style.width = '25px';
            el.style.height = '41px';
            break;
    }
    
    el.style.backgroundSize = 'cover';
    el.style.cursor = 'pointer';
    
    // Create marker with proper anchor point (bottom center of the icon)
    const marker = new maplibregl.Marker({ 
        element: el,
        anchor: 'bottom' // This ensures the bottom of the marker points to the location
    })
        .setLngLat(coordinates)
        .addTo(map);
    
    if (popupText) {
        marker.setPopup(new maplibregl.Popup({ offset: 25 }).setText(popupText));
    }
    
    return marker;
}

// Add numbered marker
function addNumberedMarker(coordinates, number, popupText) {
    const el = document.createElement('div');
    el.className = 'numbered-marker';
    el.innerHTML = `<span>${number}</span>`;
    el.style.cssText = `
        width: 25px;
        height: 25px;
        background: #3887be;
        border: 2px solid #fff;
        border-radius: 50%;
        color: white;
        font-size: 12px;
        line-height: 21px;
        text-align: center;
        cursor: pointer;
        font-weight: bold;
    `;
    
    // For circular markers, use center anchor
    const marker = new maplibregl.Marker({ 
        element: el,
        anchor: 'center'
    })
        .setLngLat(coordinates)
        .addTo(map);
    
    if (popupText) {
        marker.setPopup(new maplibregl.Popup({ offset: 25 }).setText(popupText));
    }
    
    return marker;
}

// Sidebar functions
function showSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.add('active');
    sidebarOpen = true;
    updateSidebarTabIcon();

    if (window.innerWidth > 600) {
        map.easeTo({
            padding: { right: 400 },
            duration: 300
        });
    }
}

function hideSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.remove('active');
    sidebarOpen = false;
    updateSidebarTabIcon();

    map.easeTo({
        padding: { right: 0 },
        duration: 300
    });
}

function openSidebar() {
    if (sidebarOpen) {
        hideSidebar();
    } else {
        showSidebar();
    }
}

// Utility functions
function copyURL() {
    if (window.AndroidFunction) {
        AndroidFunction.copyTextToClipboard(window.location.href);
    } else {
        navigator.clipboard.writeText(window.location.href);
    }
    
    $('#snackbar').attr('class','show');
    setTimeout(function(){ $('#snackbar').attr('class',''); }, 2900);
}

function leave() {
    history.back();
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    initializeMapAndTrips();
});


const tab = document.getElementById('sidebar-tab');
const tabIcon = document.getElementById('sidebar-tab-icon');

tabIcon.addEventListener('click', () => {
    if (sidebarOpen) {
        hideSidebar();
    } else {
        showSidebar();
    }
    updateSidebarTabIcon();
});

function updateSidebarTabIcon() {
    tabIcon.className = sidebarOpen ? 'fas fa-xmark' : 'fas fa-bars';
}


// Handle window resize
window.addEventListener('resize', () => {
    if (sidebarOpen && window.innerWidth > 600) {
        map.easeTo({
            padding: { right: 400 },
            duration: 300
        });
    } else {
        map.easeTo({
            padding: { right: 0 },
            duration: 300
        });
    }
});
</script>
{% endblock %}
