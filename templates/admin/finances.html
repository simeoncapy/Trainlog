{% extends "bootstrap/layout.html" %}
{% block content %}

{% include "bootstrap/navigation.html"%}

<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Monthly Trainlog's Finances</h2>
        <a href="{{ url_for('finance.manage') }}" class="btn btn-outline-success">
            <i class="fas fa-cog"></i> Manage Expenses
        </a>
    </div>
    
    <div id="financeChart" style="width: 100%; height: 500px;"></div>
</div>

<!-- Displaying Totals Below the Chart using Bootstrap 5 cards -->
<div class="container mt-4">
    <h4 id="yearLabel" class="text-center mb-3">Year Totals</h4>
    <div class="row text-center">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <h5 class="card-title text-primary">Total Income</h5>
                    <p class="card-text" id="totalRevenue">0 €</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm border-danger">
                <div class="card-body">
                    <h5 class="card-title text-danger">Total Hosting Spending</h5>
                    <p class="card-text" id="totalHosting">0 €</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm border-danger">
                <div class="card-body">
                    <h5 class="card-title text-danger">Total Translation Spending</h5>
                    <p class="card-text" id="totalTranslation">0 €</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row text-center">
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm border-danger">
                <div class="card-body">
                    <h5 class="card-title text-danger">API Subscriptions</h5>
                    <p class="card-text" id="totalApi">0 €</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm border-danger">
                <div class="card-body">
                    <h5 class="card-title text-danger">Total Spending</h5>
                    <p class="card-text" id="totalSpending">0 €</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card shadow-sm" id="profitCard">
                <div class="card-body">
                    <h5 class="card-title" id="profitTitle">Net Result</h5>
                    <p class="card-text" id="totalProfit">0 €</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Data Button -->
<div class="container mt-4 text-center">
    <button class="btn btn-primary" onclick="exportData()">Export Data as CSV</button>
</div>

<script>
    var chartDom = document.getElementById('financeChart');
    var myChart = echarts.init(chartDom);
    
    var labels = {{ labels | tojson }};
    var revenueDataPoints = {{ revenue_data_points | tojson }};
    var hostingSpendingDataPoints = {{ hosting_spending_data_points | tojson }};
    var translationSpendingDataPoints = {{ translation_spending_data_points | tojson }};
    var apiSubscriptionSpendingDataPoints = {{ api_subscription_spending_data_points | tojson }};
    var apiTopupSpendingDataPoints = {{ api_topup_spending_data_points | tojson }};
    var totalSpendingDataPoints = {{ total_spending_data_points | tojson }};
    var profitDataPoints = {{ profit_data_points | tojson }};
    
    var outstandingInfo = {{ outstanding_info | tojson if outstanding_info else 'null' }};
    
    // Calculate cumulative profit per year (resets each January)
    var cumulativeProfitDataPoints = [];
    var yearlyAccumulator = 0;
    var currentYear = null;
    
    labels.forEach((label, index) => {
        var year = label.substring(0, 4);
        if (year !== currentYear) {
            yearlyAccumulator = 0;
            currentYear = year;
        }
        yearlyAccumulator += profitDataPoints[index];
        cumulativeProfitDataPoints[index] = yearlyAccumulator;
    });

    // Find the indices for the default zoom range (current year)
    var currentYearStr = new Date().getFullYear().toString();
    var startIndex = labels.findIndex(l => l.startsWith(currentYearStr));
    if (startIndex === -1) startIndex = Math.max(0, labels.length - 12);
    var endIndex = labels.length - 1;

    // Function to update totals based on visible range
    function updateTotals(startIdx, endIdx) {
        var visibleLabels = labels.slice(startIdx, endIdx + 1);
        var years = [...new Set(visibleLabels.map(l => l.substring(0, 4)))];
        
        var revenue = 0, hosting = 0, translation = 0, api = 0;
        for (var i = startIdx; i <= endIdx; i++) {
            revenue += revenueDataPoints[i];
            hosting += hostingSpendingDataPoints[i];
            translation += translationSpendingDataPoints[i];
            api += apiSubscriptionSpendingDataPoints[i];
        }
        var spending = hosting + translation + api;
        var profit = revenue + spending;
        
        document.getElementById('yearLabel').textContent = years.length === 1 ? years[0] + ' Totals' : years.join('-') + ' Totals';
        document.getElementById('totalRevenue').textContent = Math.round(revenue) + ' €';
        document.getElementById('totalHosting').textContent = Math.round(-hosting) + ' €';
        document.getElementById('totalTranslation').textContent = Math.round(-translation) + ' €';
        document.getElementById('totalApi').textContent = Math.round(-api) + ' €';
        document.getElementById('totalSpending').textContent = Math.round(-spending) + ' €';
        document.getElementById('totalProfit').textContent = Math.round(profit) + ' €';
        
        var card = document.getElementById('profitCard');
        var title = document.getElementById('profitTitle');
        card.className = 'card shadow-sm ' + (profit >= 0 ? 'border-success' : 'border-danger');
        title.className = 'card-title ' + (profit >= 0 ? 'text-success' : 'text-danger');
    }

    // Create series data with outstanding indicators (lighter shade for pending revenue)
    var revenueSeriesData = revenueDataPoints.map((value, index) => {
        var item = { value: value };
        
        if (outstandingInfo && outstandingInfo.next_payout_date && outstandingInfo.total_pending > 0) {
            var payoutMonth = outstandingInfo.next_payout_date.substr(0, 7);
            if (labels[index] === payoutMonth) {
                var baseRevenue = value - outstandingInfo.total_pending;
                return [
                    { value: baseRevenue, itemStyle: { color: '#4CAF50' } },
                    { value: outstandingInfo.total_pending, itemStyle: { color: '#81C784' } }
                ];
            }
        }
        return item;
    });

    // Flatten the revenue data for stacked display
    var receivedRevenueData = [];
    var pendingRevenueData = [];
    
    revenueSeriesData.forEach((item, index) => {
        if (Array.isArray(item)) {
            receivedRevenueData.push(item[0].value);
            pendingRevenueData.push(item[1].value);
        } else {
            receivedRevenueData.push(item.value);
            pendingRevenueData.push(0);
        }
    });

    var option = {
        tooltip: {
            trigger: 'axis',
            backgroundColor: 'rgba(50, 50, 50, 0.7)',
            borderColor: '#777',
            borderWidth: 1,
            textStyle: {
                color: '#fff'
            },
            formatter: function (params) {
                var tooltipText = `<strong>${params[0].axisValue}</strong><br>`;
                
                var totalIncome = 0;
                var pendingIncome = 0;
                var otherItems = [];
                
                params.forEach(function (param) {
                    if (param.seriesName === 'Received Income') {
                        totalIncome += param.value;
                    } else if (param.seriesName === 'Pending Income') {
                        pendingIncome = param.value;
                        totalIncome += param.value;
                    } else {
                        otherItems.push(param);
                    }
                });
                
                if (pendingIncome > 0) {
                    tooltipText += `<span style="color:#4CAF50">●</span> Total Income: ${totalIncome.toFixed(2)} €<br>`;
                    tooltipText += `&nbsp;&nbsp;<span style="color:#81C784">○</span> <em>Pending: ${pendingIncome.toFixed(2)} €</em><br>`;
                } else if (totalIncome > 0) {
                    tooltipText += `<span style="color:#4CAF50">●</span> Income: ${totalIncome.toFixed(2)} €<br>`;
                }
                
                otherItems.forEach(function (param) {
                    tooltipText += `${param.marker} ${param.seriesName}: ${param.value.toFixed(2)} €<br>`;
                });
                
                return tooltipText;
            }
        },
        legend: {
            data: ['Received Income', 'Pending Income', 'Hosting Spending', 'Translation Spending', 'API Subscriptions', 'Net Result', 'Yearly Cumulative'],
            top: 10,
            textStyle: {
                color: '#333',
                fontSize: 14
            }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: labels,
            axisLine: {
                lineStyle: {
                    color: '#777'
                }
            },
            axisLabel: {
                color: '#333',
                fontSize: 12
            }
        },
        yAxis: {
            type: 'value',
            axisLine: {
                lineStyle: {
                    color: '#777'
                }
            },
            axisLabel: {
                formatter: '{value} €',
                color: '#333',
                fontSize: 12
            },
            splitLine: {
                lineStyle: {
                    type: 'dashed'
                }
            }
        },
        dataZoom: [
            {
                type: 'slider',
                startValue: startIndex,
                endValue: endIndex,
                bottom: '5%'
            },
            {
                type: 'inside',
                startValue: startIndex,
                endValue: endIndex
            }
        ],
        series: [
            {
                name: 'Received Income',
                type: 'bar',
                stack: 'Income',
                data: receivedRevenueData,
                itemStyle: {
                    color: '#4CAF50',
                    shadowBlur: 1,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                emphasis: {
                    itemStyle: {
                        color: '#388E3C'
                    }
                },
                barCategoryGap: '30%'
            },
            {
                name: 'Pending Income',
                type: 'bar',
                stack: 'Income',
                data: pendingRevenueData,
                itemStyle: {
                    color: '#81C784',
                    shadowBlur: 1,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                emphasis: {
                    itemStyle: {
                        color: '#66BB6A'
                    }
                },
                barCategoryGap: '30%'
            },
            {
                name: 'Hosting Spending',
                type: 'bar',
                stack: 'Spending',
                data: hostingSpendingDataPoints,
                itemStyle: {
                    color: '#F44336',
                    shadowBlur: 1,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                emphasis: {
                    itemStyle: {
                        color: '#D32F2F'
                    }
                },
                barCategoryGap: '30%'
            },
            {
                name: 'Translation Spending',
                type: 'bar',
                stack: 'Spending',
                data: translationSpendingDataPoints,
                itemStyle: {
                    color: '#FFCDD2',
                    shadowBlur: 1,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                emphasis: {
                    itemStyle: {
                        color: '#EF9A9A'
                    }
                },
                barCategoryGap: '30%'
            },
            {
                name: 'API Subscriptions',
                type: 'bar',
                stack: 'Spending',
                data: apiSubscriptionSpendingDataPoints,
                itemStyle: {
                    color: '#FF5722',
                    shadowBlur: 1,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                emphasis: {
                    itemStyle: {
                        color: '#E64A19'
                    }
                },
                barCategoryGap: '30%'
            },
            {
                name: 'Net Result',
                type: 'line',
                data: profitDataPoints,
                itemStyle: {
                    color: '#FF9800',
                    shadowBlur: 1,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                lineStyle: {
                    width: 2
                },
                emphasis: {
                    itemStyle: {
                        color: '#F57C00'
                    }
                },
                smooth: true
            },
            {
                name: 'Yearly Cumulative',
                type: 'line',
                data: cumulativeProfitDataPoints,
                itemStyle: {
                    color: '#2196F3',
                    shadowBlur: 1,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                lineStyle: {
                    width: 2,
                    type: 'dashed'
                },
                emphasis: {
                    itemStyle: {
                        color: '#1976D2'
                    }
                },
                smooth: true
            }
        ]
    };

    myChart.setOption(option);
    
    // Initial totals update
    updateTotals(startIndex, endIndex);
    
    // Update totals when zoom changes
    myChart.on('dataZoom', function() {
        var opt = myChart.getOption();
        var start = Math.round(opt.dataZoom[0].startValue);
        var end = Math.round(opt.dataZoom[0].endValue);
        updateTotals(start, end);
    });

    function exportData() {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Date,Income,Hosting Spending,Translation Spending,API Subscriptions,Net Result,Yearly Cumulative\n";
        labels.forEach((label, index) => {
            let row = [
                label,
                revenueDataPoints[index],
                hostingSpendingDataPoints[index],
                translationSpendingDataPoints[index],
                apiSubscriptionSpendingDataPoints[index],
                profitDataPoints[index],
                cumulativeProfitDataPoints[index]
            ].join(",");
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "trainlog_finances.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

{% endblock %}